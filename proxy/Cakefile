fs = require 'fs'
{exec, spawn, execSync} = require 'child_process'

# All coffeescript files required.
FILES = [
  'shims.coffee'
  'util.coffee'
  'proxypair.coffee'
  'websocket.coffee'
  'broker.coffee'
  'ui.coffee'
  'snowflake.coffee'
]
FILES_SPEC = [
  'spec/util.spec.coffee'
  'spec/ui.spec.coffee'
  'spec/proxypair.spec.coffee'
  'spec/snowflake.spec.coffee'
]
FILES_ALL = FILES.concat FILES_SPEC
OUTFILE = 'build/snowflake.coffee'
STATIC = 'static'

concatCoffeeFiles = -> exec 'cat ' + FILES.join(' ') + ' | cat > ' + OUTFILE

copyStaticFiles = -> exec 'cp ' + STATIC + '/* build/'

compileCoffee = ->
  exec 'coffee -o build -cb ' + OUTFILE, (err, stdout, stderr) ->
    throw err if err

task 'test', 'snowflake unit tests', ->
  exec 'mkdir -p build'
  exec 'jasmine init >&-'
  # Simply concat all the files because we're not using node exports.
  jasmineFiles = FILES.concat FILES_SPEC
  outFile = 'build/bundle.spec.coffee'
  exec 'cat ' + jasmineFiles.join(' ') +  ' | cat > ' + outFile
  execSync 'coffee -cb ' + outFile
  spawn 'jasmine', ['build/bundle.spec.js'], {
    stdio: 'inherit'
  }

task 'build', 'build the snowflake proxy', ->
  exec 'mkdir -p build'
  concatCoffeeFiles()
  copyStaticFiles()
  compileCoffee()
  console.log 'Snowflake prepared.'

task 'lint', 'ensure idiomatic coffeescript', ->
  spawn 'coffeelint', FILES_ALL, {
    file: 'coffeelint.json'
    stdio: 'inherit'
  }

task 'clean', 'remove all built files', ->
  exec 'rm -r build'
